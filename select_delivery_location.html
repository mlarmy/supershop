<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Delivery Location</title>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');


        :root {
            --color-background: #fff;
            --color-primary: #F36944;
            --color-base: #FEC92B;
            --color-sky: #74C0FC;
            --color-green-gray: #63E6BE;
            --color-pink-gray: #E599F7;
            --text-black-color: #000;
            --text-white-color: #fff;
            --text-gray-color: rgb(59, 59, 59);
            --logo-size: 50px;
            --name-size: 20px;
            --navber-height: 60px;
            --mneu-item-font-size: 15px;
            --left-right-padding-size: 10vw;
            --primary-border-radius: 10px;
            --background-base-color: #74c1fc15;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        body {
            font-family: 'Roboto', sans-serif;
        }
        .container {
            text-align: center;
            margin: 20px;
        }
        #coords {
            margin-top: 20px;
            display: none; /* Hidden by default */
        }
        textarea {
            width: 100%;
            height: 60px;
            resize: none;
        }
        #searchInput {
            padding: 8px;
            outline: none;
            border: 1px solid gray;
            border-radius: 5px;
        }
        #searchInput:focus {
            outline: auto;
            outline-color: aqua;
        }
        #searchBtn {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid gray;
        }
        #confirmLocation {
            padding: 10px;
            border: 1px solid #63E6BE;
            background-color: #1ad49d;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h3>Select Delivery Location</h3>
    <input id="searchInput" type="text" placeholder="Search for your location" />
    <button id="searchBtn">Search</button>
    <div id="map"></div>
    <button id="confirmLocation">Confirm Location</button>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import {
    getDatabase,
    ref,
    onValue,
    get,
    set,
    } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import {
    getAuth,
    onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let user_uid = "";
    let isUser = false;

    // Authenticate user
    auth.onAuthStateChanged((user) => {
        if (user) {
            user_uid = user.uid;
            isUser = true;
        }
    });


    // Initialize the map centered at Baliati, Satoriya, Manikgonj
    const defaultLocation = [23.8928, 90.0158]; // Baliati, Manikgonj
    const map = L.map('map').setView(defaultLocation, 7);

    // Add high-quality OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors',
    }).addTo(map);

    // Define the bounds for Bangladesh
    const bangladeshBounds = [
        [20.5, 88.0],  // Southwest corner
        [26.5, 92.5]   // Northeast corner
    ];

    // Set the map view bounds to Bangladesh
    map.setMaxBounds(bangladeshBounds);
    map.setMinZoom(7); // Set minimum zoom level

    // Initialize the geocoder
    const geocoder = L.Control.Geocoder.nominatim();

    let marker;

    // Add search functionality
    document.getElementById('searchBtn').addEventListener('click', function () {
        const input = document.getElementById('searchInput').value;
        geocoder.geocode(input, function(results) {
            if (results.length > 0) {
                const latlng = results[0].center;
                // Check if the location is within the bounds of Bangladesh
                if (latlng.lat >= bangladeshBounds[0][0] && latlng.lat <= bangladeshBounds[1][0] &&
                    latlng.lng >= bangladeshBounds[0][1] && latlng.lng <= bangladeshBounds[1][1]) {
                    map.setView(latlng, 15);
                    setMarker(latlng);
                } else {
                    alert('Location not found in Bangladesh.');
                }
            } else {
                alert('Location not found. Please try a different search term.');
            }
        });
    });

    // Function to set marker on the map
    function setMarker(latlng) {
        if (marker) {
            marker.setLatLng(latlng);
        } else {
            marker = L.marker(latlng).addTo(map);
        }
    }

    // Add a marker on manual click
    map.on('click', function (e) {
        setMarker(e.latlng);
    });

    document.getElementById('confirmLocation').addEventListener('click', function (event) {
        event.preventDefault();
        event.stopPropagation(); // Stop the event from affecting the parent page

        if (marker) {
            const lat = marker.getLatLng().lat;
            const lng = marker.getLatLng().lng;

            if (isUser && user_uid) {
                const userRef_for_map = ref(db, `users/${user_uid}/location`);
                window.parent.document.getElementById("map_latitude").value = lat;
                window.parent.document.getElementById("map_longitude").value = lng;
            }
        } else {
            alert('Please select a delivery location on the map.');
        }
    });
</script>
</body>
</html>
